apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "matter-temperature-sensor.fullname" . }}-app
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "matter-temperature-sensor.labels" . | nindent 4 }}
data:
  package.json: |
    {
      "name": "matter-temperature-sensor",
      "version": "1.0.0",
      "description": "Matter Temperature Sensor Device",
      "main": "index.js",
      "type": "module",
      "scripts": {
        "start": "node index.js"
      },
      "dependencies": {
        "@matter/main": "^0.15.6"
      },
      "engines": {
        "node": ">=22.0.0"
      }
    }

  index.js: |
    /**
     * Matter Temperature Sensor Device
     *
     * This creates a virtual Matter temperature sensor that reports
     * a fixed temperature of 10°C (Celsius).
     *
     * In the future, this can be extended to fetch temperature from
     * a weather API.
     */

    import { Endpoint, Environment, ServerNode, StorageBackendDisk } from "@matter/main";
    import { TemperatureMeasurementServer } from "@matter/main/behaviors";
    import { TemperatureSensorDevice } from "@matter/main/devices";
    import { VendorId } from "@matter/main/types";

    // Configuration
    const DEVICE_NAME = "Virtual Temperature Sensor";
    const VENDOR_NAME = "HomeLabIoT";
    const VENDOR_ID = 0xfff1; // Test Vendor ID
    const PRODUCT_NAME = "Matter Temperature Sensor";
    const PRODUCT_ID = 0x8001;
    const FIXED_TEMPERATURE = 10; // 10°C - Fixed temperature value

    /**
     * Main function to create and start the Matter temperature sensor
     */
    async function main() {
        console.log("Starting Matter Temperature Sensor...");
        console.log(`Fixed Temperature: ${FIXED_TEMPERATURE}°C`);

        try {
            // Create Matter environment with storage
            const environment = Environment.default;

            // Use disk storage for device persistence
            const storageLocation = process.env.STORAGE_PATH || "/data";
            environment.set(StorageBackendDisk, { path: storageLocation });

            console.log(`Storage location: ${storageLocation}`);

            // Create the Matter server node
            const serverNode = await ServerNode.create({
                id: "temperature-sensor-node",
                network: {
                    port: 5540,
                    advertiseOnStartup: true,
                },
                productDescription: {
                    name: PRODUCT_NAME,
                    deviceType: TemperatureSensorDevice.deviceType,
                },
                basicInformation: {
                    vendorId: VendorId(VENDOR_ID),
                    vendorName: VENDOR_NAME,
                    productId: PRODUCT_ID,
                    productName: PRODUCT_NAME,
                    productLabel: DEVICE_NAME,
                    serialNumber: `TS-${Date.now()}`,
                    uniqueId: `temperature-sensor-${Date.now()}`,
                },
            });

            // Create temperature sensor endpoint with fixed temperature
            const temperatureSensor = new Endpoint(TemperatureSensorDevice, {
                id: "temperature-sensor",
                temperatureMeasurement: {
                    // Matter uses centi-degrees Celsius (1/100th of a degree)
                    // So 10°C = 1000 centi-degrees
                    measuredValue: FIXED_TEMPERATURE * 100,
                    minMeasuredValue: -5000, // -50°C
                    maxMeasuredValue: 12000,  // 120°C
                },
            });

            // Add the temperature sensor endpoint to the server
            await serverNode.add(temperatureSensor);

            console.log("Temperature sensor endpoint created");

            // Start the Matter server
            await serverNode.run();

            console.log("Matter Temperature Sensor is running!");
            console.log("Device can now be commissioned and paired with Matter controllers");
            console.log(`Current temperature: ${FIXED_TEMPERATURE}°C`);

            // Optional: Update temperature periodically (for future weather API integration)
            // This is commented out as we're using a fixed value for now
            /*
            setInterval(async () => {
                // In the future, fetch from weather API here
                const newTemp = FIXED_TEMPERATURE; // Replace with API call
                await temperatureSensor.set({
                    temperatureMeasurement: {
                        measuredValue: newTemp * 100
                    }
                });
                console.log(`Temperature updated: ${newTemp}°C`);
            }, 60000); // Update every 60 seconds
            */

        } catch (error) {
            console.error("Error starting Matter Temperature Sensor:", error);
            process.exit(1);
        }
    }

    // Handle shutdown gracefully
    process.on('SIGINT', () => {
        console.log("\nShutting down Matter Temperature Sensor...");
        process.exit(0);
    });

    process.on('SIGTERM', () => {
        console.log("\nShutting down Matter Temperature Sensor...");
        process.exit(0);
    });

    // Start the application
    main().catch((error) => {
        console.error("Fatal error:", error);
        process.exit(1);
    });
