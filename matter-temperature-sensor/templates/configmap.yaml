apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "matter-temperature-sensor.fullname" . }}-app
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "matter-temperature-sensor.labels" . | nindent 4 }}
data:
  package.json: |
    {
      "name": "matter-temperature-sensor",
      "version": "1.0.0",
      "description": "Matter Temperature Sensor Device",
      "main": "index.js",
      "type": "module",
      "scripts": {
        "start": "node index.js"
      },
      "dependencies": {
        "@matter/main": "^0.15.6"
      },
      "engines": {
        "node": ">=22.0.0"
      }
    }

  index.js: |
    /**
     * Matter Multi-Sensor Weather Station
     *
     * This creates a virtual Matter device with multiple sensors:
     * - Temperature sensor
     * - Humidity sensor
     * - Pressure sensor
     *
     * All sensors report real-time data from OpenWeatherMap API.
     * Data is fetched every 10 minutes and updated automatically.
     */

    import { Endpoint, Environment, ServerNode, StorageService } from "@matter/main";
    import { TemperatureMeasurementServer, RelativeHumidityMeasurementServer, PressureMeasurementServer } from "@matter/main/behaviors";
    import { TemperatureSensorDevice, HumiditySensorDevice, PressureSensorDevice } from "@matter/main/devices";
    import { VendorId } from "@matter/main/types";

    // Configuration
    const DEVICE_NAME = "Weather Station";
    const VENDOR_NAME = "HomeLabIoT";
    const VENDOR_ID = 0xfff1; // Test Vendor ID
    const PRODUCT_NAME = "Matter Weather Station";
    const PRODUCT_ID = 0x8001;

    // Matter protocol port (can be customized for multiple sensors)
    const MATTER_PORT = parseInt(process.env.MATTER_PORT || "5540", 10);

    // OpenWeatherMap API Configuration
    const OPENWEATHER_API_KEY = process.env.OPENWEATHER_API_KEY;
    const LATITUDE = 37.324146498307215;
    const LONGITUDE = 127.09286670930126;
    const UPDATE_INTERVAL = 10 * 60 * 1000; // 10 minutes in milliseconds

    // Fallback values if API fails
    const FALLBACK_TEMPERATURE = 10; // 10°C
    const FALLBACK_HUMIDITY = 50; // 50%
    const FALLBACK_PRESSURE = 1013; // 1013 hPa (standard atmospheric pressure)

    /**
     * Fetch current weather data from OpenWeatherMap API
     * @returns {Promise<{temperature: number, humidity: number, pressure: number}>}
     */
    async function fetchWeatherData() {
        if (!OPENWEATHER_API_KEY) {
            console.warn("⚠️ OPENWEATHER_API_KEY not set, using fallback values");
            return {
                temperature: FALLBACK_TEMPERATURE,
                humidity: FALLBACK_HUMIDITY,
                pressure: FALLBACK_PRESSURE
            };
        }

        try {
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${LATITUDE}&lon=${LONGITUDE}&appid=${OPENWEATHER_API_KEY}&units=metric`;

            console.log(`Fetching weather data from OpenWeatherMap...`);
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            const temperature = data.main.temp;
            const humidity = data.main.humidity;
            const pressure = data.main.pressure;

            console.log(`✓ Weather data received: ${temperature}°C, ${humidity}%, ${pressure}hPa (${data.weather[0].description})`);
            console.log(`  Location: ${data.name}, ${data.sys.country}`);

            return { temperature, humidity, pressure };
        } catch (error) {
            console.error(`✗ Failed to fetch weather data from OpenWeatherMap: ${error.message}`);
            console.log(`Using fallback values: ${FALLBACK_TEMPERATURE}°C, ${FALLBACK_HUMIDITY}%, ${FALLBACK_PRESSURE}hPa`);
            return {
                temperature: FALLBACK_TEMPERATURE,
                humidity: FALLBACK_HUMIDITY,
                pressure: FALLBACK_PRESSURE
            };
        }
    }

    /**
     * Main function to create and start the Matter weather station
     */
    async function main() {
        console.log("Starting Matter Weather Station (OpenWeatherMap Integration)...");
        console.log(`Matter port: ${MATTER_PORT}`);
        console.log(`Location: Latitude ${LATITUDE}, Longitude ${LONGITUDE}`);
        console.log(`Update interval: ${UPDATE_INTERVAL / 60000} minutes`);

        try {
            // Create Matter environment
            const environment = Environment.default;

            // Storage is automatically configured by the environment
            const storageService = environment.get(StorageService);
            console.log(`Storage location: ${storageService.location}`);

            // Fetch initial weather data
            const initialData = await fetchWeatherData();
            console.log(`Initial data: ${initialData.temperature}°C, ${initialData.humidity}%, ${initialData.pressure}hPa`);

            // Create the Matter server node
            const serverNode = await ServerNode.create({
                id: "weather-station-node",
                network: {
                    port: MATTER_PORT,
                    advertiseOnStartup: true,
                },
                productDescription: {
                    name: PRODUCT_NAME,
                    deviceType: TemperatureSensorDevice.deviceType,
                },
                basicInformation: {
                    vendorId: VendorId(VENDOR_ID),
                    vendorName: VENDOR_NAME,
                    productId: PRODUCT_ID,
                    productName: PRODUCT_NAME,
                    productLabel: DEVICE_NAME,
                    serialNumber: "WS-HOMELAB-001",
                    uniqueId: "homelab-weather-station-001",
                },
            });

            // Create temperature sensor endpoint
            const temperatureSensor = new Endpoint(TemperatureSensorDevice, {
                id: "temperature",
                temperatureMeasurement: {
                    // Matter uses centi-degrees Celsius (1/100th of a degree)
                    // So 10°C = 1000 centi-degrees
                    measuredValue: Math.round(initialData.temperature * 100),
                    minMeasuredValue: -5000, // -50°C
                    maxMeasuredValue: 12000,  // 120°C
                },
            });

            // Create humidity sensor endpoint
            const humiditySensor = new Endpoint(HumiditySensorDevice, {
                id: "humidity",
                relativeHumidityMeasurement: {
                    // Matter uses percentage * 100 (0-10000 range for 0-100%)
                    measuredValue: Math.round(initialData.humidity * 100),
                    minMeasuredValue: 0,      // 0%
                    maxMeasuredValue: 10000,  // 100%
                },
            });

            // Create pressure sensor endpoint
            const pressureSensor = new Endpoint(PressureSensorDevice, {
                id: "pressure",
                pressureMeasurement: {
                    // Matter uses 1/10 hPa (decipascals)
                    // So 1013 hPa = 10130 decipascals
                    measuredValue: Math.round(initialData.pressure * 10),
                    minMeasuredValue: 8000,   // 800 hPa
                    maxMeasuredValue: 12000,  // 1200 hPa
                },
            });

            // Add all sensor endpoints to the server
            await serverNode.add(temperatureSensor);
            await serverNode.add(humiditySensor);
            await serverNode.add(pressureSensor);

            console.log("✓ Temperature sensor endpoint created");
            console.log("✓ Humidity sensor endpoint created");
            console.log("✓ Pressure sensor endpoint created");

            // Start the Matter server
            await serverNode.run();

            console.log("✓ Matter Weather Station is running!");
            console.log("✓ Device can now be commissioned and paired with Matter controllers");
            console.log(`✓ Current readings:`);
            console.log(`  - Temperature: ${initialData.temperature}°C`);
            console.log(`  - Humidity: ${initialData.humidity}%`);
            console.log(`  - Pressure: ${initialData.pressure}hPa`);
            console.log("");

            // Update function to refresh sensor data from OpenWeatherMap
            let updateCount = 0;
            const updateSensors = async () => {
                updateCount++;
                console.log(`\n[Update #${updateCount}] Updating weather data...`);

                const weatherData = await fetchWeatherData();

                try {
                    // Update temperature sensor
                    await temperatureSensor.set({
                        temperatureMeasurement: {
                            measuredValue: Math.round(weatherData.temperature * 100)
                        }
                    });
                    console.log(`✓ Temperature updated: ${weatherData.temperature}°C`);

                    // Update humidity sensor
                    await humiditySensor.set({
                        relativeHumidityMeasurement: {
                            measuredValue: Math.round(weatherData.humidity * 100)
                        }
                    });
                    console.log(`✓ Humidity updated: ${weatherData.humidity}%`);

                    // Update pressure sensor
                    await pressureSensor.set({
                        pressureMeasurement: {
                            measuredValue: Math.round(weatherData.pressure * 10)
                        }
                    });
                    console.log(`✓ Pressure updated: ${weatherData.pressure}hPa`);

                } catch (error) {
                    console.error(`✗ Failed to update sensors: ${error.message}`);
                }

                console.log(`Next update in ${UPDATE_INTERVAL / 60000} minutes\n`);
            };

            // Start periodic updates immediately after a short delay
            // This ensures the first update happens soon after startup (not after 10 minutes)
            console.log("Starting periodic weather updates...");
            console.log("First update will occur in 1 minute");
            setTimeout(async () => {
                await updateSensors();
                // After first update, continue with regular interval
                setInterval(updateSensors, UPDATE_INTERVAL);
            }, 60000); // First update after 1 minute

        } catch (error) {
            console.error("Error starting Matter Weather Station:", error);
            process.exit(1);
        }
    }

    // Handle shutdown gracefully
    process.on('SIGINT', () => {
        console.log("\nShutting down Matter Weather Station...");
        process.exit(0);
    });

    process.on('SIGTERM', () => {
        console.log("\nShutting down Matter Weather Station...");
        process.exit(0);
    });

    // Start the application
    main().catch((error) => {
        console.error("Fatal error:", error);
        process.exit(1);
    });
