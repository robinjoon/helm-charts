apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "matter-temperature-sensor.fullname" . }}-app
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "matter-temperature-sensor.labels" . | nindent 4 }}
data:
  package.json: |
    {
      "name": "matter-temperature-sensor",
      "version": "1.0.0",
      "description": "Matter Temperature Sensor Device",
      "main": "index.js",
      "type": "module",
      "scripts": {
        "start": "node index.js"
      },
      "dependencies": {
        "@matter/main": "^0.15.6"
      },
      "engines": {
        "node": ">=22.0.0"
      }
    }

  index.js: |
    import { Endpoint, Environment, Logger, ServerNode, StorageService, Time } from "@matter/main";
    import { TemperatureSensorDevice, HumiditySensorDevice, PressureSensorDevice } from "@matter/main/devices";
    import { DeviceTypeId, VendorId } from "@matter/main/types";

    const logger = Logger.get("WeatherStationNode");

    // OpenWeatherMap API Configuration
    const OPENWEATHER_API_KEY = process.env.OPENWEATHER_API_KEY;
    // Seoul Coordinates
    const LATITUDE = 37.324146498307215;
    const LONGITUDE = 127.09286670930126;

    // Fallback values
    const FALLBACK_TEMPERATURE = 10;
    const FALLBACK_HUMIDITY = 50;
    const FALLBACK_PRESSURE = 1013;

    async function main() {
        /** Initialize configuration values */
        const {
            uniqueId,
            port,
            passcode,
            discriminator,
            vendorId,
            productId,
            deviceName,
            productName,
            vendorName,
            interval
        } = await getConfiguration();

        /** * 초기 날씨 데이터 가져오기
         * (서버 시작 전에 초기값을 확보하기 위함)
         */
        const initialData = await fetchWeatherData();

        /**
         * Create a Matter ServerNode
         */
        const server = await ServerNode.create({
            // Required: Give the Node a unique ID which is used to store the state of this node
            id: uniqueId,

            // Provide Network relevant configuration like the port
            network: {
                port,
            },

            // Provide Commissioning relevant settings
            commissioning: {
                passcode,
                discriminator,
            },

            // Provide Node announcement settings
            productDescription: {
                name: deviceName,
                deviceType: DeviceTypeId(TemperatureSensorDevice.deviceType), // 대표 Device Type 설정
            },

            // Provide defaults for the BasicInformation cluster on the Root endpoint
            basicInformation: {
                vendorName,
                vendorId: VendorId(vendorId),
                nodeLabel: productName,
                productName,
                productLabel: productName,
                productId,
                serialNumber: `matterjs-${uniqueId}`,
                uniqueId,
            },
        });

        /**
         * Endpoints 생성 및 추가
         * 온도, 습도, 기압 센서 각각 생성
         */

            // 1. Temperature Sensor Endpoint
        const temperatureEndpoint = new Endpoint(TemperatureSensorDevice, {
                id: "temperature",
                temperatureMeasurement: {
                    measuredValue: Math.round(initialData.temperature * 100), // 0.01도 단위
                    minMeasuredValue: -5000,
                    maxMeasuredValue: 12000,
                },
            });

        // 2. Humidity Sensor Endpoint
        const humidityEndpoint = new Endpoint(HumiditySensorDevice, {
            id: "humidity",
            relativeHumidityMeasurement: {
                measuredValue: Math.round(initialData.humidity * 100), // 0.01% 단위
                minMeasuredValue: 0,
                maxMeasuredValue: 10000,
            },
        });

        // 3. Pressure Sensor Endpoint
        const pressureEndpoint = new Endpoint(PressureSensorDevice, {
            id: "pressure",
            pressureMeasurement: {
                measuredValue: Math.round(initialData.pressure * 10), // 0.1 hPa 단위
                minMeasuredValue: 8000,
                maxMeasuredValue: 12000,
            },
        });

        await server.add(temperatureEndpoint);
        await server.add(humidityEndpoint);
        await server.add(pressureEndpoint);

        /**
         * Log the endpoint structure for debugging
         */
        logger.info("Endpoints created and added to server.");

        /**
         * 주기적 업데이트 로직 (setInterval)
         */
        let updateCount = 0;
        const updateInterval = setInterval(async () => {
            try {
                updateCount++;
                const now = new Date().toLocaleTimeString();

                // 데이터 가져오기
                const weatherData = await fetchWeatherData();

                // 각 엔드포인트 값 업데이트
                await temperatureEndpoint.set({
                    temperatureMeasurement: {
                        measuredValue: Math.round(weatherData.temperature * 100)
                    }
                });

                await humidityEndpoint.set({
                    relativeHumidityMeasurement: {
                        measuredValue: Math.round(weatherData.humidity * 100)
                    }
                });

                await pressureEndpoint.set({
                    pressureMeasurement: {
                        measuredValue: Math.round(weatherData.pressure * 10)
                    }
                });

                console.log(`[${now}] Update #${updateCount} Success: Temp ${weatherData.temperature}°C, Hum ${weatherData.humidity}%, Press ${weatherData.pressure}hPa`);

            } catch (error) {
                console.error("Error updating sensor values:", error);
            }
        }, interval * 1000); // interval seconds * 1000 ms

        // Cleanup our update interval when node goes offline
        server.lifecycle.offline.on(() => clearTimeout(updateInterval));

        /**
         * Run Server
         */
        console.log(`Update interval set to ${interval} seconds.`);
        await server.run();
    }

    main().catch(error => console.error(error));

    /*********************************************************************************************************
     * Convenience Methods & Helpers
     *********************************************************************************************************/

    /**
     * Fetch current weather data from OpenWeatherMap API
     */
    async function fetchWeatherData() {
        if (!OPENWEATHER_API_KEY) {
            console.warn("⚠️ OPENWEATHER_API_KEY not set, using fallback values");
            return {
                temperature: FALLBACK_TEMPERATURE,
                humidity: FALLBACK_HUMIDITY,
                pressure: FALLBACK_PRESSURE,
                location: "Fallback"
            };
        }

        try {
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${LATITUDE}&lon=${LONGITUDE}&appid=${OPENWEATHER_API_KEY}&units=metric`;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return {
                temperature: data.main.temp,
                humidity: data.main.humidity,
                pressure: data.main.pressure,
                location: data.name
            };
        } catch (error) {
            console.error(`✗ Failed to fetch weather data: ${error.message}`);
            return {
                temperature: FALLBACK_TEMPERATURE,
                humidity: FALLBACK_HUMIDITY,
                pressure: FALLBACK_PRESSURE,
                location: "Error"
            };
        }
    }

    /**
     * Collect and persist configuration data
     */
    async function getConfiguration() {
        const environment = Environment.default;
        const storageService = environment.get(StorageService);

        console.log(`Storage location: ${storageService.location} (Directory)`);

        // "device" context 생성 및 데이터 로드
        const deviceStorage = (await storageService.open("device")).createContext("data");

        // 기본 설정값 로드 (환경 변수 -> 스토리지 -> 기본값 순서)
        const interval = environment.vars.number("interval") ?? (await deviceStorage.get("interval", 600)); // 600초 기본

        const deviceName = "Weather Station";
        const vendorName = "HomeLabIoT";
        const productName = "Matter Weather Station";

        const passcode = environment.vars.number("passcode") ?? (await deviceStorage.get("passcode", 20202021));
        const discriminator = environment.vars.number("discriminator") ?? (await deviceStorage.get("discriminator", 3840));

        const vendorId = environment.vars.number("vendorid") ?? (await deviceStorage.get("vendorid", 0xfff1));
        const productId = environment.vars.number("productid") ?? (await deviceStorage.get("productid", 0x8001));

        const port = environment.vars.number("port") ?? 5540;

        // Unique ID 생성 또는 로드 (재시작 시 동일 ID 유지 위함)
        // Ensure uniqueId does not contain dots (Time.nowMs might return a float)
        let uniqueId = environment.vars.string("uniqueid") ?? (await deviceStorage.get("uniqueid", Math.round(Time.nowMs).toString()));
        uniqueId = uniqueId.replace(/\./g, "");

        // 중요 설정값 영구 저장
        await deviceStorage.set({
            passcode,
            discriminator,
            vendorid: vendorId,
            productid: productId,
            interval,
            uniqueid: uniqueId,
        });

        return {
            uniqueId,
            port,
            passcode,
            discriminator,
            vendorId,
            productId,
            deviceName,
            productName,
            vendorName,
            interval
        };
    }